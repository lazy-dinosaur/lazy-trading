import{b as k,j as e,C as je,X as re,x,B as f,d as ge,a as fe,i as pe,r as C,A as G,D as h,T as X,f as J,g as Y,h as Z,V as ee}from"./index--mJaizsc.js";import{u as be}from"./use-CR7JZOh1.js";import{S as Ne}from"./screen-wrapper-ka0X-mpj.js";import{C as P,b as R,d as D,c as S,e as se,a as E}from"./card-BfKKBDHD.js";import{T as ye,a as ve,W as we,B as Ce}from"./badge-DiYZZrWm.js";import{S as ke}from"./scroll-area-DBFoBbvv.js";import{u as _e,C as Pe,c as Re}from"./capital-change-chart-E-7GhRz2.js";import{D as De,a as Se,b as $e,c as Ae,d as Le,e as z}from"./dialog-Cmf3KlYu.js";import{L as Fe}from"./loader-circle-B8TOKiKB.js";import{C as Ie}from"./circle-check-big-DlXXzgVz.js";import{I as ae}from"./info-CBKQO1mY.js";import{R as B}from"./refresh-cw-wChuhh6Z.js";import{P as te}from"./plus-BZGkxMGm.js";import"./arrow-left-CNAqUfmD.js";import"./index-BdQq_4o_.js";/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=k("ChartLine",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=k("CircleArrowDown",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 8v8",key:"napkw2"}],["path",{d:"m8 12 4 4 4-4",key:"k98ssh"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=k("CircleArrowUp",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m16 12-4-4-4 4",key:"177agl"}],["path",{d:"M12 16V8",key:"1sbj14"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=k("CreditCard",[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]]);/**
 * @license lucide-react v0.469.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=k("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]);function Be({isOpen:a,onClose:m,position:o,onConfirm:$,isClosing:l,closeError:j,isSuccess:A}){return o?e.jsx(De,{open:a,onOpenChange:L=>!L&&m(),children:e.jsxs(Se,{className:"sm:max-w-[360px] p-4 gap-2 w-[calc(100%-32px)]",children:[e.jsxs(je,{className:"absolute right-2 top-2 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[e.jsx(re,{className:"h-3 w-3"}),e.jsx("span",{className:"sr-only",children:"Close"})]}),e.jsxs($e,{className:"pb-1",children:[e.jsx(Ae,{className:"text-base",children:"포지션 종료 확인"}),e.jsx(Le,{className:"text-xs",children:"다음 포지션을 종료하시겠습니까?"})]}),!A&&!j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid gap-2 py-1",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 rounded-lg border p-3 text-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"심볼"}),e.jsx("p",{className:"font-semibold",children:o.symbol})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"포지션"}),e.jsx("p",{className:"font-semibold",children:o.side==="long"?"롱":"숏"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"사이즈"}),e.jsx("p",{className:"font-semibold",children:o.size})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"PnL"}),e.jsxs("p",{className:`font-semibold ${o.pnl>=0?"text-green-500":"text-red-500"}`,children:[o.pnl>=0?"+":"",x(o.pnl)]})]}),e.jsxs("div",{className:"space-y-1 col-span-2",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"계정"}),e.jsxs("p",{className:"font-semibold text-sm",children:[o.accountName," (",o.exchange,")"]})]})]})}),e.jsxs(z,{className:"sm:justify-between pt-1",children:[e.jsx(f,{variant:"outline",size:"sm",onClick:m,className:"h-8",children:"취소"}),e.jsx(f,{onClick:()=>o&&$(o),disabled:l,className:"bg-red-500 hover:bg-red-600 h-8",size:"sm",children:l?e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"mr-1 h-3 w-3 animate-spin"}),"종료 중..."]}):"포지션 종료"})]})]}):j?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col items-center justify-center py-3",children:[e.jsx(ye,{className:"h-10 w-10 text-red-500 mb-2"}),e.jsx("h3",{className:"text-base font-semibold mb-1",children:"종료 실패"}),e.jsx("p",{className:"text-center text-xs text-muted-foreground",children:j})]}),e.jsx(z,{children:e.jsx(f,{size:"sm",onClick:m,className:"w-full h-8",children:"확인"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col items-center justify-center py-3",children:[e.jsx(Ie,{className:"h-10 w-10 text-green-500 mb-2"}),e.jsx("h3",{className:"text-base font-semibold mb-1",children:"종료 성공"}),e.jsxs("p",{className:"text-center text-xs text-muted-foreground",children:[o.symbol," ",o.side==="long"?"롱":"숏"," 포지션이 성공적으로 종료되었습니다."]})]}),e.jsx(z,{children:e.jsx(f,{size:"sm",onClick:m,className:"w-full h-8",children:"확인"})})]})]})}):null}const ts=()=>{const{t:a}=ge(),m=fe(),o=pe(),{accounts:$,decryptedAccounts:l,accountsBalance:j,isLoading:A}=be(),[L,M]=C.useState(null),[ne,q]=C.useState(!1),[le,H]=C.useState(!1),[ie,F]=C.useState(null),[V,I]=C.useState(!1),{data:g=[],isLoading:w,error:oe}=_e("all"),_=!!oe,b=(g==null?void 0:g.map(s=>({time:s.time||s.date||"",value:s.value||s.balance||0})))||[],de=async s=>{H(!0),F(null);try{if(!l)throw new Error("계정 정보를 찾을 수 없습니다.");const t=l[s.accountId];if(!t)throw new Error("계정 정보를 찾을 수 없습니다.");await t.exchangeInstance.ccxt.createOrder(s.symbol,"market",s.side==="long"?"sell":"buy",s.size,void 0,{reduceOnly:!0}),I(!0),ee.success(a("trade.close_position_success",{symbol:s.symbol})),o.invalidateQueries({queryKey:["positions"]})}catch(t){console.error("포지션 종료 중 오류 발생:",t),F(t instanceof Error?t.message:a("common.error")),ee.error(a("trade.close_position_error"))}finally{H(!1)}},he=s=>{M(s),q(!0),I(!1),F(null)},xe=()=>{q(!1),V&&setTimeout(()=>{M(null),I(!1)},300)},me=Object.values(j||{}).reduce((s,t)=>{var r,c;return s+(((c=(r=t.balance)==null?void 0:r.usd)==null?void 0:c.total)||0)},0),O=Object.values(j||{}).sort((s,t)=>{var r,c,n,d;return(((c=(r=t.balance)==null?void 0:r.usd)==null?void 0:c.total)||0)-(((d=(n=s.balance)==null?void 0:n.usd)==null?void 0:d.total)||0)}).slice(0,5),ue=Object.keys($||{}).length,U=(s,t,r)=>{const c=[];for(const n of s)try{const d=n.side.toLowerCase();if(d!=="long"&&d!=="short")continue;const N=n.contracts||0;if(N<=0)continue;const u=n.entryPrice||0,p=n.markPrice||0,y=n.unrealizedPnl||0;let v=0;u>0&&(d==="long"?v=(p-u)/u*100:v=(u-p)/u*100),c.push({id:`${t.exchange}-${n.symbol}-${n.side}-${r}`,symbol:n.symbol,side:d,size:N,entryPrice:u,markPrice:p,pnl:y,pnlPercentage:v,accountId:r,accountName:t.name,exchange:t.exchange})}catch(d){console.error("Error processing position data:",d)}return c},{data:K=[],isLoading:Q}=G({queryKey:["positions",l],queryFn:async()=>{if(!l||Object.keys(l).length===0)return[];const s=l,t=[];for(const r in s){const c=s[r];try{const n=c.exchangeInstance.ccxt,d=c.exchange;try{console.log(`${d}: 포지션 정보 가져오기 시도`);const N=await c.exchangeInstance.pro.watchPositions();console.log(`${d}: 포지션 정보 가져오기 성공`);const u=N.filter(y=>y.contracts!==void 0&&y.contracts>0),p=U(u,c,r);t.push(...p)}catch(N){console.error(`Error fetching positions from ${c.exchange}:`,N);try{console.log(`${d}: watchPositions 실패, fetchPositions 시도`);const p=(await n.fetchPositions()).filter(v=>v.contracts!==void 0&&v.contracts>0),y=U(p,c,r);t.push(...y)}catch(u){console.error(`Fallback fetchPositions also failed for ${c.exchange}:`,u)}}}catch(n){console.error(`Error processing account ${r}:`,n)}}return t.sort((r,c)=>Math.abs(c.pnl)-Math.abs(r.pnl))},enabled:!!l&&Object.keys(l).length>0,refetchInterval:500,staleTime:1/0}),{data:i,isLoading:W}=G({queryKey:["adjustedReturn",g,l],queryFn:async()=>w||_||!g||g.length<2||!l||Object.keys(l).length===0?{initialAsset:0,finalAsset:0,deposits:0,withdrawals:0,averageCapital:0,periodReturn:0,adjustedReturnRate:0,hasValidData:!1}:Re(l,g),enabled:!w&&!_&&!!g&&g.length>=2&&!!l&&Object.keys(l).length>0}),T=(()=>{var c,n;if(w||_||!b||b.length<2)return null;const s=(c=b[0])==null?void 0:c.value,t=(n=b[b.length-1])==null?void 0:n.value;return!s||s===0||!t?null:(t-s)/s*100})();return e.jsxs(Ne,{headerProps:{title:"Dashboard"},className:"flex flex-col h-full overflow-auto scrollbar-thin scrollbar-thumb-border scrollbar-track-background",children:[e.jsxs("div",{className:"space-y-5 pb-20 lg:grid lg:grid-cols-2 lg:gap-5 lg:space-y-0",children:[e.jsxs("div",{className:"space-y-5 lg:col-span-1",children:[e.jsxs(P,{className:"bg-primary/5",children:[e.jsxs(R,{className:"pb-2",children:[e.jsx(D,{children:a("dashboard.total_balance")}),e.jsx(S,{className:"text-2xl lg:text-3xl flex items-center",children:j?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-6 w-6 mr-1"}),x(me)]}):e.jsx(h,{className:"h-10 w-32"})}),i!=null&&i.hasValidData?e.jsxs("div",{className:`flex items-center text-sm mt-1 ${i.adjustedReturnRate>=0?"text-green-500":"text-red-500"}`,children:[e.jsx(ve,{className:"h-4 w-4 mr-1"}),e.jsxs("span",{className:"flex items-center",children:[a("dashboard.adjusted_return")," ",i.adjustedReturnRate>=0?"+":"",i.adjustedReturnRate.toFixed(2),"%",e.jsx(X,{children:e.jsxs(J,{children:[e.jsx(Y,{asChild:!0,children:e.jsx(ae,{className:"h-3.5 w-3.5 ml-1 cursor-help opacity-70"})}),e.jsxs(Z,{className:"max-w-[280px]",children:[e.jsx("p",{className:"font-medium mb-1",children:a("dashboard.adjusted_return_formula")}),e.jsxs("ul",{className:"text-xs space-y-1",children:[e.jsxs("li",{children:["• ",a("dashboard.period_profit")," ",x(i.periodReturn)]}),e.jsxs("li",{children:["• ",a("dashboard.investment_capital_full")," ",x(i.averageCapital)]}),e.jsxs("li",{className:"pt-1",children:["• ",a("dashboard.initial_asset")," ",x(i.initialAsset)]}),e.jsxs("li",{children:["• ",a("dashboard.current_asset")," ",x(i.finalAsset)]}),e.jsxs("li",{children:["• ",a("dashboard.deposits")," ",x(i.deposits)]}),e.jsxs("li",{children:["• ",a("dashboard.withdrawals")," ",x(i.withdrawals)]}),e.jsx("li",{className:"pt-1 text-muted-foreground",children:a("dashboard.investment_formula")})]})]})]})})]})]}):e.jsx("div",{className:"text-xs text-muted-foreground mt-1 flex items-center",children:w||W?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"h-3 w-3 mr-1 animate-spin"}),a("dashboard.adjusted_return_loading")]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{children:a("dashboard.adjusted_return_unavailable")}),e.jsx(X,{children:e.jsxs(J,{children:[e.jsx(Y,{asChild:!0,children:e.jsx(ae,{className:"h-3.5 w-3.5 ml-1 cursor-help opacity-70"})}),e.jsx(Z,{children:e.jsx("p",{children:a("dashboard.error_occurred")})})]})})]})}),T!==null&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[a("dashboard.simple_change_rate")," ",T>=0?"+":"",T.toFixed(2),"%"]})]}),e.jsx(se,{className:"pt-2 flex justify-end",children:!j&&e.jsx(B,{className:"h-4 w-4 animate-spin text-muted-foreground"})})]}),e.jsxs(P,{children:[e.jsxs(R,{children:[e.jsx(S,{children:a("dashboard.asset_change")}),e.jsxs(D,{className:"flex flex-col",children:[e.jsx("span",{children:a("dashboard.asset_change_desc")}),(i==null?void 0:i.hasValidData)&&e.jsxs("span",{className:"text-xs mt-1",children:[a("dashboard.investment_capital"),x(i.averageCapital)]})]})]}),e.jsx(E,{children:e.jsx(Pe,{data:b,isLoading:w||A||W,isError:_,height:250,adjustedReturn:i})})]})]})," ",e.jsxs("div",{className:"space-y-5 lg:col-span-1",children:[e.jsxs(P,{children:[e.jsxs(R,{className:"pb-2 flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(S,{children:a("dashboard.account_count",{count:ue})}),e.jsx(D,{children:a("dashboard.connected_exchange_accounts")})]}),e.jsxs(f,{variant:"outline",onClick:()=>m("/account/add?exchange=bybit"),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),a("dashboard.add_account")]})]}),e.jsx(E,{className:"space-y-2",children:j?O.length>0?O.map(s=>{var t,r;return e.jsxs("div",{className:"flex items-center justify-between p-2 hover:bg-secondary/20 rounded cursor-pointer",onClick:()=>m(`/account/detail/${s.account.id}`),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(we,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.account.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.account.exchange})]})]}),e.jsxs("p",{className:"font-medium",children:["$",x(((r=(t=s.balance)==null?void 0:t.usd)==null?void 0:r.total)||0)]})]},s.account.id)}):e.jsxs("div",{className:"py-8 text-center text-muted-foreground",children:[e.jsx(Ee,{className:"h-10 w-10 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:a("dashboard.no_accounts")}),e.jsxs(f,{className:"mt-4",variant:"outline",onClick:()=>m("/account/add"),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),a("dashboard.add_account_button")]})]}):Array(3).fill(0).map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between p-2 hover:bg-secondary/20 rounded",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(h,{className:"h-5 w-5 rounded-full"})," ",e.jsxs("div",{children:[e.jsx(h,{className:"h-5 w-24 mb-1"})," ",e.jsx(h,{className:"h-3 w-16"})," "]})]}),e.jsx(h,{className:"h-5 w-20"})," "]},t))}),O.length>0&&e.jsx(se,{children:e.jsx(f,{variant:"ghost",className:"w-full",onClick:()=>m("/accounts"),children:a("dashboard.view_all_accounts")})})]}),e.jsxs(P,{children:[e.jsxs(R,{className:"pb-2 flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(S,{children:a("dashboard.active_positions")}),e.jsx(D,{children:a("dashboard.active_positions_desc")})]}),Q&&e.jsx(B,{className:"h-4 w-4 animate-spin"})]}),e.jsx(E,{children:e.jsx(ke,{className:"h-[200px] lg:h-[300px] pr-4",children:e.jsx("div",{className:"space-y-2",children:Q?Array(3).fill(0).map((s,t)=>e.jsxs("div",{className:"flex flex-col p-3 border rounded-lg mb-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{className:"h-5 w-5 rounded-full"})," ",e.jsx(h,{className:"h-5 w-16"})," ",e.jsx(h,{className:"h-5 w-12 rounded-full"})," "]}),e.jsx(h,{className:"h-5 w-24"})," "]}),e.jsxs("div",{className:"flex justify-between text-sm mt-2",children:[e.jsxs("div",{children:[e.jsx(h,{className:"h-4 w-20 mb-1"})," ",e.jsx(h,{className:"h-4 w-28"})," "]}),e.jsxs("div",{className:"text-right",children:[e.jsx(h,{className:"h-4 w-28 mb-1"})," ",e.jsx(h,{className:"h-4 w-32"})," "]})]})]},t)):K.length>0?K.map(s=>e.jsxs("div",{className:"flex flex-col p-3 border rounded-lg hover:bg-secondary/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2 cursor-pointer",onClick:()=>m(`/trade?symbol=${s.symbol}&id=${s.accountId}&exchange=${s.exchange}`,{state:{fromPosition:!0}}),children:[s.side==="long"?e.jsx(Te,{className:"h-5 w-5 text-green-500"}):e.jsx(Oe,{className:"h-5 w-5 text-red-500"}),e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(Ce,{variant:s.side==="long"?"outline":"secondary",children:s.side==="long"?"LONG":"SHORT"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:`font-medium ${s.pnl>=0?"text-green-500":"text-red-500"}`,children:[s.pnl>=0?"+":"",x(s.pnl)," (",s.pnlPercentage.toFixed(2),"%)"]}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-6 w-6 text-destructive hover:text-destructive/80 p-0",onClick:t=>{t.stopPropagation(),he(s)},children:e.jsx(re,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground cursor-pointer",onClick:()=>m(`/trade?symbol=${s.symbol}&id=${s.accountId}&exchange=${s.exchange}`,{state:{fromPosition:!0}}),children:[e.jsxs("div",{children:[e.jsxs("div",{children:[s.size.toFixed(s.size<1?4:2)," ",a("dashboard.contract")]}),e.jsxs("div",{children:[a("dashboard.entry")," ",x(s.entryPrice)]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{children:[a("dashboard.mark")," ",x(s.markPrice)]}),e.jsxs("div",{children:[s.accountName," (",s.exchange,")"]})]})]})]},s.id)):e.jsxs("div",{className:"py-8 text-center text-muted-foreground",children:[e.jsx(ce,{className:"h-10 w-10 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:a("dashboard.no_active_positions")}),e.jsxs(f,{className:"mt-4",variant:"outline",onClick:()=>m("/search"),children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),a("dashboard.search_trades")]})]})})})})]})]})," "]}),e.jsx(Be,{isOpen:ne,onClose:xe,position:L,onConfirm:de,isClosing:le,closeError:ie,isSuccess:V})]})};export{ts as default};
